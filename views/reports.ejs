<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Panel de Reportes Detallados - Sistema de gestión de flotilla vehicular">
    <meta name="theme-color" content="#001f3f">
    <title>Reportes Detallados | CRM Insurance System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script>
        // Tab functionality - Define globally BEFORE page loads
        window.showTab = function(tabName, buttonElement) {
            console.log('showTab called with:', tabName, buttonElement);
            
            // Hide all tab contents
            var tabContents = document.querySelectorAll('.tab-content');
            for (var i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            // Remove active class from all tab buttons
            var tabButtons = document.querySelectorAll('.tab');
            for (var i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove('active');
            }
            
            // Show selected tab content
            var tabContent = document.getElementById(tabName);
            if (tabContent) {
                tabContent.classList.add('active');
                console.log('Tab content activated:', tabName);
            } else {
                console.error('Tab content not found:', tabName);
            }
            
            // Activate the clicked button
            if (buttonElement) {
                buttonElement.classList.add('active');
                console.log('Button activated');
            } else {
                // Fallback: find button by tab name
                var buttons = document.querySelectorAll('.tab');
                for (var i = 0; i < buttons.length; i++) {
                    var btn = buttons[i];
                    var onclickAttr = btn.getAttribute('onclick');
                    if (onclickAttr && onclickAttr.indexOf(tabName) !== -1) {
                        btn.classList.add('active');
                    }
                }
            }
        };
    </script>
    <style>
        :root {
            --primary: #001f3f;
            --secondary: #87ceeb;
            --accent: #4da6ff;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border: #dee2e6;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Open Sans', sans-serif;
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
        }
        header {
            background-color: white;
            border-bottom: 1px solid var(--border);
            padding: 0;
            margin-bottom: 0;
            box-shadow: var(--shadow);
        }
        .header-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .logo img {
            height: 40px;
            width: auto;
        }
        .logo-text {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary);
        }
        .logo-text span {
            color: var(--accent);
        }
        .btn {
            padding: 10px 24px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn:hover {
            background-color: #003366;
        }
        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .btn-export {
            background-color: var(--success);
        }
        .btn-export:hover {
            background-color: #218838;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        .page-header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        .page-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
        }
        .page-subtitle {
            color: var(--gray);
            font-size: 1.1rem;
        }
        .period-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .period-selector select {
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
        }
        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .kpi-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }
        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .kpi-label {
            font-size: 0.85rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        .kpi-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        .kpi-icon.fuel { background: linear-gradient(135deg, #4da6ff, #0066cc); color: white; }
        .kpi-icon.maintenance { background: linear-gradient(135deg, #28a745, #1e7e34); color: white; }
        .kpi-icon.fines { background: linear-gradient(135deg, #ffc107, #e0a800); color: white; }
        .kpi-icon.claims { background: linear-gradient(135deg, #dc3545, #c82333); color: white; }
        .kpi-icon.vehicles { background: linear-gradient(135deg, #001f3f, #003366); color: white; }
        .kpi-icon.total { background: linear-gradient(135deg, #6f42c1, #5a32a3); color: white; }
        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Montserrat', sans-serif;
            margin-bottom: 8px;
        }
        .kpi-change {
            font-size: 0.85rem;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        /* Sections */
        .section {
            background: white;
            border-radius: 12px;
            padding: 28px;
            border: 1px solid var(--border);
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border);
        }
        .section-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .section-title i {
            color: var(--primary);
            font-size: 1.3rem;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        .chart-container-large {
            height: 500px;
        }
        .chart-container-small {
            height: 300px;
        }
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        thead {
            background: linear-gradient(135deg, var(--primary), #003366);
            color: white;
        }
        th {
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            color: var(--dark);
            font-size: 0.95rem;
        }
        tbody tr {
            transition: background-color 0.15s;
        }
        tbody tr:hover {
            background-color: #f8f9fa;
        }
        tbody tr:last-child td {
            border-bottom: none;
        }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge-success {
            background-color: #d4edda;
            color: #155724;
        }
        .badge-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        .badge-danger {
            background-color: #f8d7da;
            color: #721c24;
        }
        .badge-info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            text-align: center;
        }
        .stat-label {
            font-size: 0.85rem;
            color: var(--gray);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Montserrat', sans-serif;
        }
        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray);
            transition: all 0.2s;
        }
        .tab:hover {
            color: var(--primary);
        }
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Responsive */
        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            .chart-container {
                height: 300px;
            }
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }
    </style>
</head>
<body>
    <header>
        <div class="header-container">
            <div class="logo">
                <img src="/images/logo.png" alt="Logo">
                <div class="logo-text">CRM <span>Insurance</span> System</div>
            </div>
            <div style="display: flex; gap: 12px;">
                <a href="/dashboard" class="btn">Dashboard</a>
                <a href="/vehicles" class="btn">Vehículos</a>
                <a href="/api/download-report" class="btn btn-export" target="_blank">
                    <i class="fas fa-download"></i> Exportar PDF
                </a>
                <a href="/logout" class="btn btn-secondary">Cerrar Sesión</a>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="page-header">
            <div>
                <h1 class="page-title">
                    <i class="fas fa-chart-line"></i> Panel de Reportes Detallados
                </h1>
                <p class="page-subtitle">Análisis completo y métricas de tu flotilla vehicular</p>
            </div>
            <div class="period-selector">
                <label for="period" style="font-weight: 600;">Período:</label>
                <select id="period" onchange="window.location.href='/reports?period=' + this.value">
                    <option value="1month" <%= period === '1month' ? 'selected' : '' %>>Último Mes</option>
                    <option value="3months" <%= period === '3months' ? 'selected' : '' %>>Últimos 3 Meses</option>
                    <option value="6months" <%= period === '6months' ? 'selected' : '' %>>Últimos 6 Meses</option>
                    <option value="12months" <%= period === '12months' ? 'selected' : '' %>>Último Año</option>
                </select>
            </div>
        </div>

        <!-- KPIs Principales -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-label">Total Vehículos</div>
                    <div class="kpi-icon vehicles">
                        <i class="fas fa-car"></i>
            </div>
            </div>
                <div class="kpi-value"><%= stats.totalVehicles || 0 %></div>
                <div class="kpi-change">
                    <i class="fas fa-info-circle"></i>
                    <%= stats.activeVehicles || 0 %> activos
            </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-label">Costo Total</div>
                    <div class="kpi-icon total">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <div class="kpi-value">$<%= (stats.totalCost || 0).toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></div>
                <div class="kpi-change">
                    <i class="fas fa-chart-line"></i>
                    Período seleccionado
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-label">Combustible</div>
                    <div class="kpi-icon fuel">
                        <i class="fas fa-gas-pump"></i>
                    </div>
                </div>
                <div class="kpi-value">$<%= (stats.totalFuelCost || 0).toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></div>
                <div class="kpi-change">
                    <i class="fas fa-list"></i>
                    <%= stats.totalRecords || 0 %> registros
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-label">Mantenimiento</div>
                    <div class="kpi-icon maintenance">
                        <i class="fas fa-tools"></i>
                    </div>
                </div>
                <div class="kpi-value">$<%= (stats.totalMaintenanceCost || 0).toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></div>
                <div class="kpi-change">
                    <i class="fas fa-wrench"></i>
                    <%= stats.totalMaintenanceRecords || 0 %> servicios
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-label">Multas</div>
                    <div class="kpi-icon fines">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
                <div class="kpi-value">$<%= (stats.totalFinesCost || 0).toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></div>
                <div class="kpi-change">
                    <i class="fas fa-file-invoice"></i>
                    <%= stats.totalFines || 0 %> multas
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-label">Siniestros</div>
                    <div class="kpi-icon claims">
                        <i class="fas fa-car-crash"></i>
                    </div>
                </div>
                <div class="kpi-value">$<%= (stats.totalClaimsCost || 0).toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></div>
                <div class="kpi-change">
                    <i class="fas fa-clipboard-list"></i>
                    <%= stats.totalClaims || 0 %> siniestros
                </div>
            </div>
        </div>

        <!-- KPIs de Costo por Kilómetro -->
        <div class="kpi-grid" style="margin-top: 20px;">
            <div class="kpi-card" style="border-left: 4px solid #001f3f;">
                <div class="kpi-header">
                    <div class="kpi-label">Costo Total por Km</div>
                    <div class="kpi-icon" style="background: #001f3f;">
                        <i class="fas fa-route"></i>
                    </div>
                </div>
                <div class="kpi-value">$<%= (stats.totalCostPerKm || 0).toFixed(2) %></div>
                <div class="kpi-change">
                    <i class="fas fa-road"></i>
                    <%= (stats.totalKilometers || 0).toLocaleString('es-MX') %> km recorridos
                </div>
            </div>
            <div class="kpi-card" style="border-left: 4px solid #001f3f;">
                <div class="kpi-header">
                    <div class="kpi-label">Costo Fijo por Km</div>
                    <div class="kpi-icon" style="background: #001f3f;">
                        <i class="fas fa-lock"></i>
                    </div>
                </div>
                <div class="kpi-value">$<%= (stats.fixedCostPerKm || 0).toFixed(2) %></div>
                <div class="kpi-change">
                    <i class="fas fa-dollar-sign"></i>
                    $<%= (stats.totalFixedCosts || 0).toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %> total
                </div>
            </div>
            <div class="kpi-card" style="border-left: 4px solid #87ceeb;">
                <div class="kpi-header">
                    <div class="kpi-label">Costo Variable por Km</div>
                    <div class="kpi-icon" style="background: #87ceeb;">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
                <div class="kpi-value">$<%= (stats.variableCostPerKm || 0).toFixed(2) %></div>
                <div class="kpi-change">
                    <i class="fas fa-dollar-sign"></i>
                    $<%= (stats.totalVariableCosts || 0).toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %> total
                </div>
            </div>
        </div>

        <!-- Tabs para diferentes secciones -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('overview', this)">
                <i class="fas fa-chart-pie"></i> Resumen General
            </button>
            <button class="tab" onclick="showTab('fuel', this)">
                <i class="fas fa-gas-pump"></i> Combustible
            </button>
            <button class="tab" onclick="showTab('maintenance', this)">
                <i class="fas fa-tools"></i> Mantenimiento
            </button>
            <button class="tab" onclick="showTab('fines', this)">
                <i class="fas fa-exclamation-triangle"></i> Multas
            </button>
            <button class="tab" onclick="showTab('claims', this)">
                <i class="fas fa-car-crash"></i> Siniestros
            </button>
            <button class="tab" onclick="showTab('carta-porte', this)">
                <i class="fas fa-file-invoice"></i> Carta Porte
            </button>
            <button class="tab" onclick="showTab('vehicles', this)">
                <i class="fas fa-car"></i> Por Vehículo
            </button>
            <button class="tab" onclick="showTab('cost-per-km', this)">
                <i class="fas fa-route"></i> Costo por Km
            </button>
        </div>

        <!-- Tab: Resumen General -->
        <div id="overview" class="tab-content active">
            <!-- Distribución de Costos -->
            <% 
            var hasCostData = false;
            if (costBreakdown && costBreakdown.length > 0) {
                for (var i = 0; i < costBreakdown.length; i++) {
                    if (costBreakdown[i].amount > 0) {
                        hasCostData = true;
                        break;
                    }
                }
            }
            if (hasCostData) { %>
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-chart-pie"></i>
                        Distribución de Costos por Categoría
                    </h2>
                </div>
                <div class="chart-container">
                    <canvas id="costBreakdownChart"></canvas>
                </div>
            </div>
            <% } else { %>
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-chart-pie"></i>
                        Distribución de Costos por Categoría
                    </h2>
                </div>
                <div class="loading">
                    <i class="fas fa-info-circle"></i> No hay datos de costos para el período seleccionado
                </div>
            </div>
            <% } %>

            <!-- Tendencias Mensuales -->
        <% if (monthlyTrends && monthlyTrends.length > 0) { %>
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-chart-line"></i>
                        Tendencias Mensuales de Costos
                </h2>
            </div>
                <div class="chart-container chart-container-large">
                <canvas id="monthlyTrendsChart"></canvas>
            </div>
        </div>
        <% } %>

            <!-- Tendencias Semanales -->
            <% if (weeklyTrends && weeklyTrends.length > 0) { %>
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-chart-area"></i>
                        Tendencias Semanales (Últimas 12 Semanas)
                    </h2>
                </div>
                <div class="chart-container">
                    <canvas id="weeklyTrendsChart"></canvas>
                </div>
            </div>
            <% } %>

            <!-- Tendencias Diarias -->
            <% if (dailyTrends && dailyTrends.length > 0) { %>
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-chart-bar"></i>
                        Tendencias Diarias (Últimos 30 Días)
                    </h2>
                </div>
                <div class="chart-container">
                    <canvas id="dailyTrendsChart"></canvas>
                </div>
            </div>
            <% } %>

            <!-- Top 10 Vehículos por Costo -->
            <% if (topCostDrivers && topCostDrivers.length > 0) { %>
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-trophy"></i>
                        Top 10 Vehículos con Mayor Costo
                    </h2>
                </div>
                <div class="chart-container">
                    <canvas id="topCostDriversChart"></canvas>
                </div>
            </div>
            <% } %>

            <!-- Estado de Vehículos -->
            <% if (vehicleStatus && Object.keys(vehicleStatus).length > 0) { %>
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-info-circle"></i>
                        Distribución por Estado de Vehículos
                    </h2>
                </div>
                <div class="chart-container chart-container-small">
                    <canvas id="vehicleStatusChart"></canvas>
                </div>
            </div>
            <% } %>
        </div>

        <!-- Tab: Combustible -->
        <div id="fuel" class="tab-content">
            <!-- Eficiencia de Combustible -->
            <% if (fuelEfficiency && fuelEfficiency.length > 0) { %>
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-tachometer-alt"></i>
                        Eficiencia de Combustible por Vehículo
                    </h2>
                </div>
                <div class="chart-container chart-container-large">
                    <canvas id="fuelEfficiencyChart"></canvas>
                </div>
            </div>
            <% } %>

        <!-- Consumo de Combustible por Vehículo -->
        <% if (fuelData && fuelData.length > 0) { %>
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-gas-pump"></i>
                        Consumo de Combustible Detallado
                </h2>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Vehículo</th>
                        <th>Registros</th>
                        <th>Total Litros</th>
                        <th>Costo Total</th>
                        <th>Consumo Promedio</th>
                        <th>Kilometraje Recorrido</th>
                            <th>Precio Promedio/Litro</th>
                    </tr>
                </thead>
                <tbody>
                    <% fuelData.forEach(function(vehicle) { %>
                    <tr>
                        <td class="font-weight-bold">#<%= vehicle.numero_vehiculo %> - <%= vehicle.marca %> <%= vehicle.modelo %></td>
                        <td><%= vehicle.fuel_records_count || 0 %></td>
                        <td><%= (vehicle.total_litros || 0).toFixed(2) %> L</td>
                        <td class="font-weight-bold">$<%= (vehicle.total_cost || 0).toFixed(2) %></td>
                        <td>
                            <% if (vehicle.avgConsumption > 0) { %>
                                    <span class="badge badge-success"><%= vehicle.avgConsumption %> km/L</span>
                            <% } else { %>
                                    <span class="badge badge-warning">N/A</span>
                            <% } %>
                        </td>
                            <td><%= (vehicle.kmDiff || 0).toLocaleString() %> km</td>
                            <td>$<%= (vehicle.avg_price_per_liter || 0).toFixed(2) %></td>
                    </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
        <% } %>
        </div>

        <!-- Tab: Mantenimiento -->
        <div id="maintenance" class="tab-content">
            <!-- Frecuencia de Mantenimiento -->
            <% if (maintenanceFrequency && maintenanceFrequency.length > 0) { %>
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-calendar-alt"></i>
                        Frecuencia de Mantenimiento por Vehículo
                    </h2>
                </div>
                <div class="chart-container">
                    <canvas id="maintenanceFrequencyChart"></canvas>
                </div>
            </div>
            <% } %>

        <!-- Mantenimientos por Vehículo -->
        <% if (maintenanceData && maintenanceData.length > 0) { %>
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-tools"></i>
                        Mantenimientos Detallados
                </h2>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Vehículo</th>
                        <th>Total Mantenimientos</th>
                        <th>Preventivos</th>
                        <th>Correctivos</th>
                        <th>Costo Total</th>
                            <th>Costo Promedio</th>
                    </tr>
                </thead>
                <tbody>
                    <% maintenanceData.forEach(function(vehicle) { %>
                    <tr>
                        <td class="font-weight-bold">#<%= vehicle.numero_vehiculo %> - <%= vehicle.marca %> <%= vehicle.modelo %></td>
                        <td><%= vehicle.maintenance_count || 0 %></td>
                            <td><span class="badge badge-success"><%= vehicle.preventive_count || 0 %></span></td>
                            <td><span class="badge badge-danger"><%= vehicle.corrective_count || 0 %></span></td>
                        <td class="font-weight-bold">$<%= (vehicle.total_cost || 0).toFixed(2) %></td>
                            <td>$<%= (vehicle.avg_cost || 0).toFixed(2) %></td>
                    </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
        <% } %>
        </div>

        <!-- Tab: Multas -->
        <div id="fines" class="tab-content">
            <% if (finesData && finesData.length > 0) { %>
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        Análisis de Multas
                    </h2>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Vehículo</th>
                            <th>Total Multas</th>
                            <th>Costo Total</th>
                            <th>Pagadas</th>
                            <th>Pendientes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% finesData.forEach(function(vehicle) { %>
                        <tr>
                            <td class="font-weight-bold">#<%= vehicle.numero_vehiculo %> - <%= vehicle.marca %> <%= vehicle.modelo %></td>
                            <td><%= vehicle.fines_count || 0 %></td>
                            <td class="font-weight-bold">$<%= (vehicle.total_cost || 0).toFixed(2) %></td>
                            <td><span class="badge badge-success">$<%= (vehicle.paid_cost || 0).toFixed(2) %></span></td>
                            <td><span class="badge badge-warning">$<%= (vehicle.pending_cost || 0).toFixed(2) %></span></td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
            <% } else { %>
            <div class="section">
                <div class="loading">
                    <i class="fas fa-info-circle"></i> No hay datos de multas para el período seleccionado
                </div>
            </div>
            <% } %>
        </div>

        <!-- Tab: Siniestros -->
        <div id="claims" class="tab-content">
            <% if (claimsData && claimsData.length > 0) { %>
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-car-crash"></i>
                        Análisis de Siniestros
                    </h2>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Vehículo</th>
                            <th>Total Siniestros</th>
                            <th>Costo Total</th>
                            <th>Costo Promedio</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% claimsData.forEach(function(vehicle) { %>
                        <tr>
                            <td class="font-weight-bold">#<%= vehicle.numero_vehiculo %> - <%= vehicle.marca %> <%= vehicle.modelo %></td>
                            <td><%= vehicle.claims_count || 0 %></td>
                            <td class="font-weight-bold text-danger">$<%= (vehicle.total_cost || 0).toFixed(2) %></td>
                            <td>$<%= (vehicle.avg_cost || 0).toFixed(2) %></td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
            <% } else { %>
            <div class="section">
                <div class="loading">
                    <i class="fas fa-info-circle"></i> No hay datos de siniestros para el período seleccionado
                </div>
            </div>
            <% } %>
        </div>

        <!-- Tab: Carta Porte -->
        <div id="carta-porte" class="tab-content">
            <% if (cartaPorteData && cartaPorteData.length > 0 && cartaPorteData[0].total_cartas > 0) { %>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Cartas Porte</div>
                    <div class="stat-value"><%= cartaPorteData[0].total_cartas || 0 %></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Emitidas</div>
                    <div class="stat-value"><%= cartaPorteData[0].emitidas || 0 %></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Con CFDI</div>
                    <div class="stat-value"><%= cartaPorteData[0].con_cfdi || 0 %></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Valor Total</div>
                    <div class="stat-value">$<%= (cartaPorteData[0].total_valor || 0).toLocaleString('es-MX', {minimumFractionDigits: 2}) %></div>
                </div>
            </div>

            <% if (cartaPorteMonthly && cartaPorteMonthly.length > 0) { %>
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-chart-line"></i>
                        Tendencias Mensuales de Carta Porte
                    </h2>
                </div>
                <div class="chart-container">
                    <canvas id="cartaPorteMonthlyChart"></canvas>
                </div>
            </div>
            <% } %>

            <% if (destinationStates && destinationStates.length > 0) { %>
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-map-marked-alt"></i>
                        Distribución por Estados de Destino
                    </h2>
                </div>
                <div class="chart-container chart-container-small">
                    <canvas id="destinationStatesChart"></canvas>
                </div>
            </div>
            <% } %>
            <% } else { %>
            <div class="section">
                <div class="loading">
                    <i class="fas fa-info-circle"></i> No hay datos de Carta Porte para el período seleccionado
                </div>
            </div>
            <% } %>
        </div>

        <!-- Tab: Por Vehículo -->
        <div id="vehicles" class="tab-content">
        <% if (vehicleComparisons && vehicleComparisons.length > 0) { %>
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-chart-bar"></i>
                        Comparativa de Costos Totales por Vehículo
                </h2>
            </div>
                <div class="chart-container chart-container-large">
                    <canvas id="vehicleComparisonsChart"></canvas>
            </div>
        </div>

            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-table"></i>
                        Desglose Detallado por Vehículo
                    </h2>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Vehículo</th>
                            <th>Estado</th>
                            <th>Combustible</th>
                            <th>Mantenimiento</th>
                            <th>Multas</th>
                            <th>Siniestros</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% vehicleComparisons.forEach(function(vehicle) { %>
                        <tr>
                            <td class="font-weight-bold">#<%= vehicle.numero_vehiculo %> - <%= vehicle.marca %> <%= vehicle.modelo %></td>
                            <td>
                                <% if (vehicle.estado === 'Activo') { %>
                                    <span class="badge badge-success"><%= vehicle.estado %></span>
                                <% } else { %>
                                    <span class="badge badge-warning"><%= vehicle.estado %></span>
                                <% } %>
                            </td>
                            <td>$<%= (vehicle.total_fuel_cost || 0).toFixed(2) %></td>
                            <td>$<%= (vehicle.total_maintenance_cost || 0).toFixed(2) %></td>
                            <td>$<%= (vehicle.total_fines_cost || 0).toFixed(2) %></td>
                            <td>$<%= (vehicle.total_claims_cost || 0).toFixed(2) %></td>
                            <td class="font-weight-bold">$<%= (vehicle.total_cost || 0).toFixed(2) %></td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
            <% } %>
        </div>

        <!-- Tab: Costo por Kilómetro -->
        <div id="cost-per-km" class="tab-content">
            <!-- Resumen de Costos Fijos vs Variables -->
            <% if (fixedVariableBreakdown && fixedVariableBreakdown.length > 0) { %>
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-balance-scale"></i>
                        Costos Fijos vs Variables
                    </h2>
                </div>
                <div class="chart-container">
                    <canvas id="fixedVariableChart"></canvas>
                </div>
            </div>
            <% } %>

            <!-- Desglose de Costos Fijos -->
            <% if (fixedCostsBreakdown && fixedCostsBreakdown.length > 0) { %>
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-lock"></i>
                        Desglose de Costos Fijos
                    </h2>
                </div>
                <div class="chart-container">
                    <canvas id="fixedCostsChart"></canvas>
                </div>
            </div>
            <% } %>

            <!-- Desglose de Costos Variables -->
            <% if (variableCostsBreakdown && variableCostsBreakdown.length > 0) { %>
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-chart-line"></i>
                        Desglose de Costos Variables
                    </h2>
                </div>
                <div class="chart-container">
                    <canvas id="variableCostsChart"></canvas>
                </div>
            </div>
            <% } %>

            <!-- Tabla de Costo por Km por Vehículo -->
            <% if (kilometersData && kilometersData.length > 0) { %>
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-table"></i>
                        Costo por Kilómetro por Vehículo
                    </h2>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Vehículo</th>
                            <th>Kilómetros Recorridos</th>
                            <th>Costos Fijos</th>
                            <th>Costos Variables</th>
                            <th>Total Costos</th>
                            <th>Costo Fijo/Km</th>
                            <th>Costo Variable/Km</th>
                            <th>Costo Total/Km</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% 
                        if (kilometersData && kilometersData.length > 0 && typeof vehicleCostsPerKm !== 'undefined') {
                            for (var kmIdx = 0; kmIdx < kilometersData.length; kmIdx++) {
                                var kmData = kilometersData[kmIdx];
                                var vehicle = null;
                                for (var i = 0; i < vehicles.length; i++) {
                                    if (vehicles[i].id === kmData.id) {
                                        vehicle = vehicles[i];
                                        break;
                                    }
                                }
                                if (!vehicle) continue;
                                
                                // Get all costs for this vehicle
                                var vCosts = vehicleCostsPerKm[kmData.id] || { fuel: 0, maintenance: 0, fines: 0, claims: 0, tires: 0, policies: 0, salaries: 0, tolls: 0, perDiem: 0, variable: 0 };
                                
                                // Calculate fixed costs: Fuel + Tires + Maintenance + Policies + Salaries
                                var fixedCosts = (vCosts.fuel || 0) + (vCosts.tires || 0) + (vCosts.maintenance || 0) + (vCosts.policies || 0) + (vCosts.salaries || 0);
                                
                                // Calculate variable costs: Tolls + Per Diem + Other Variable Expenses
                                var variableCosts = (vCosts.tolls || 0) + (vCosts.perDiem || 0) + (vCosts.variable || 0);
                                
                                var kmTraveled = kmData.km_traveled || 0;
                                var fixedCostPerKm = kmTraveled > 0 ? (fixedCosts / kmTraveled) : 0;
                                var variableCostPerKm = kmTraveled > 0 ? (variableCosts / kmTraveled) : 0;
                                var totalCostPerKm = fixedCostPerKm + variableCostPerKm;
                        %>
                        <tr>
                            <td class="font-weight-bold">#<%= vehicle.numero_vehiculo %> - <%= vehicle.marca %> <%= vehicle.modelo %></td>
                            <td><%= (kmTraveled || 0).toLocaleString('es-MX') %> km</td>
                            <td>$<%= fixedCosts.toFixed(2) %></td>
                            <td>$<%= variableCosts.toFixed(2) %></td>
                            <td class="font-weight-bold">$<%= (fixedCosts + variableCosts).toFixed(2) %></td>
                            <td>$<%= fixedCostPerKm.toFixed(2) %></td>
                            <td>$<%= variableCostPerKm.toFixed(2) %></td>
                            <td class="font-weight-bold text-primary">$<%= totalCostPerKm.toFixed(2) %></td>
                        </tr>
                        <% 
                            }
                        } else { %>
                        <tr>
                            <td colspan="8" class="text-center text-muted">
                                <i class="fas fa-info-circle"></i> No hay datos de kilómetros recorridos para calcular el costo por km
                            </td>
                        </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
            <% } else { %>
            <div class="section">
                <div class="loading">
                    <i class="fas fa-info-circle"></i> No hay datos de kilómetros recorridos para el período seleccionado
                </div>
            </div>
            <% } %>
        </div>
    </div>

    <script>
        // Chart.js configuration
        // Note: showTab is already defined in the head section
        Chart.defaults.font.family = "'Open Sans', sans-serif";
        Chart.defaults.font.size = 12;
        Chart.defaults.color = '#212529';

        // Debug: Log available data
        <% try { %>
        console.log('Cost Breakdown:', <%= JSON.stringify(costBreakdown || []) %>);
        console.log('Monthly Trends:', <%= JSON.stringify(monthlyTrends || []) %>);
        console.log('Fuel Data:', <%= JSON.stringify(fuelData || []) %>);
        <% } catch(e) { %>
        console.log('Error logging data:', e);
        <% } %>
        
        // Cost Breakdown Chart
        <% 
        var hasCostDataForChart = false;
        if (costBreakdown && costBreakdown.length > 0) {
            for (var i = 0; i < costBreakdown.length; i++) {
                if (costBreakdown[i].amount > 0) {
                    hasCostDataForChart = true;
                    break;
                }
            }
        }
        if (hasCostDataForChart) { %>
        const costBreakdownCtx = document.getElementById('costBreakdownChart');
        if (costBreakdownCtx) {
            try {
                new Chart(costBreakdownCtx, {
                    type: 'doughnut',
                    data: {
                        labels: [<%= costBreakdown.filter(c => c.amount > 0).map(c => `'${c.category}'`).join(',') %>],
                        datasets: [{
                            data: [<%= costBreakdown.filter(c => c.amount > 0).map(c => c.amount).join(',') %>],
                            backgroundColor: [<%= costBreakdown.filter(c => c.amount > 0).map(c => `'${c.color}'`).join(',') %>],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: $${value.toLocaleString('es-MX', {minimumFractionDigits: 2})} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
                });
                console.log('Cost Breakdown Chart created successfully');
            } catch (error) {
                console.error('Error creating Cost Breakdown Chart:', error);
            }
        } else {
            console.warn('Cost Breakdown Chart canvas not found');
        }
        <% } else { %>
        console.log('No cost breakdown data available or all amounts are zero');
        <% } %>

        // Monthly Trends Chart
        <% if (monthlyTrends && monthlyTrends.length > 0) { %>
        const monthlyTrendsCtx = document.getElementById('monthlyTrendsChart');
        if (monthlyTrendsCtx) {
            new Chart(monthlyTrendsCtx, {
                type: 'line',
                data: {
                    labels: [<%= monthlyTrends.map(t => `'${t.month}'`).join(',') %>],
                    datasets: [
                        {
                            label: 'Combustible',
                            data: [<%= monthlyTrends.map(t => t.fuel_cost || 0).join(',') %>],
                            borderColor: '#4da6ff',
                            backgroundColor: 'rgba(77, 166, 255, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Mantenimiento',
                            data: [<%= monthlyTrends.map(t => t.maintenance_cost || 0).join(',') %>],
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Multas',
                            data: [<%= monthlyTrends.map(t => t.fines_cost || 0).join(',') %>],
                            borderColor: '#ffc107',
                            backgroundColor: 'rgba(255, 193, 7, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Siniestros',
                            data: [<%= monthlyTrends.map(t => t.claims_cost || 0).join(',') %>],
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: $${context.parsed.y.toLocaleString('es-MX', {minimumFractionDigits: 2})}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('es-MX');
                                }
                            }
                        }
                    }
                }
            });
        }
        <% } %>

        // Weekly Trends Chart
        <% if (weeklyTrends && weeklyTrends.length > 0) { %>
        const weeklyTrendsCtx = document.getElementById('weeklyTrendsChart');
        if (weeklyTrendsCtx) {
            new Chart(weeklyTrendsCtx, {
                type: 'bar',
                data: {
                    labels: [<%= weeklyTrends.map(t => `'Semana ${t.week.split('-W')[1]}'`).join(',') %>],
                    datasets: [{
                        label: 'Costo Combustible',
                        data: [<%= weeklyTrends.map(t => t.fuel_cost || 0).join(',') %>],
                        backgroundColor: '#4da6ff',
                        borderColor: '#0066cc',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Costo: $${context.parsed.y.toLocaleString('es-MX', {minimumFractionDigits: 2})}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('es-MX');
                                }
                            }
                        }
                    }
                }
            });
        }
        <% } %>

        // Daily Trends Chart
        <% if (dailyTrends && dailyTrends.length > 0) { %>
        const dailyTrendsCtx = document.getElementById('dailyTrendsChart');
        if (dailyTrendsCtx) {
            new Chart(dailyTrendsCtx, {
                type: 'line',
                data: {
                    labels: [<%= dailyTrends.map(t => `'${t.day}'`).join(',') %>],
                    datasets: [{
                        label: 'Costo Diario',
                        data: [<%= dailyTrends.map(t => t.fuel_cost || 0).join(',') %>],
                        borderColor: '#4da6ff',
                        backgroundColor: 'rgba(77, 166, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('es-MX');
                                }
                            }
                        }
                    }
                }
            });
        }
        <% } %>

        // Top Cost Drivers Chart
        <% if (topCostDrivers && topCostDrivers.length > 0) { %>
        const topCostDriversCtx = document.getElementById('topCostDriversChart');
        if (topCostDriversCtx) {
            new Chart(topCostDriversCtx, {
                type: 'bar',
                data: {
                    labels: [<%= topCostDrivers.map(v => `'#${v.numero_vehiculo}'`).join(',') %>],
                    datasets: [
                        {
                            label: 'Combustible',
                            data: [<%= topCostDrivers.map(v => v.fuel_cost || 0).join(',') %>],
                            backgroundColor: '#4da6ff'
                        },
                        {
                            label: 'Mantenimiento',
                            data: [<%= topCostDrivers.map(v => v.maintenance_cost || 0).join(',') %>],
                            backgroundColor: '#28a745'
                        },
                        {
                            label: 'Multas',
                            data: [<%= topCostDrivers.map(v => v.fines_cost || 0).join(',') %>],
                            backgroundColor: '#ffc107'
                        },
                        {
                            label: 'Siniestros',
                            data: [<%= topCostDrivers.map(v => v.claims_cost || 0).join(',') %>],
                            backgroundColor: '#dc3545'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('es-MX');
                                }
                            }
                        }
                    }
                }
            });
        }
        <% } %>

        // Vehicle Status Chart
        <% if (vehicleStatus && Object.keys(vehicleStatus).length > 0) { %>
        const vehicleStatusCtx = document.getElementById('vehicleStatusChart');
        if (vehicleStatusCtx) {
            const statusLabels = [<%= Object.keys(vehicleStatus).map(s => `'${s}'`).join(',') %>];
            const statusData = [<%= Object.values(vehicleStatus).join(',') %>];
            const statusColors = ['#28a745', '#ffc107', '#dc3545', '#6c757d', '#17a2b8'];
            
            new Chart(vehicleStatusCtx, {
                type: 'pie',
                data: {
                    labels: statusLabels,
                    datasets: [{
                        data: statusData,
                        backgroundColor: statusColors.slice(0, statusLabels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
        }
        <% } %>

        // Fuel Efficiency Chart
        <% if (fuelEfficiency && fuelEfficiency.length > 0) { %>
        const fuelEfficiencyCtx = document.getElementById('fuelEfficiencyChart');
        if (fuelEfficiencyCtx) {
            new Chart(fuelEfficiencyCtx, {
                type: 'bar',
                data: {
                    labels: [<%= fuelEfficiency.map(v => `'#${v.numero_vehiculo}'`).join(',') %>],
                    datasets: [{
                        label: 'Kilómetros por Litro',
                        data: [<%= fuelEfficiency.map(v => v.km_per_liter || 0).join(',') %>],
                        backgroundColor: '#28a745',
                        borderColor: '#1e7e34',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} km/L`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Kilómetros por Litro'
                            }
                        }
                    }
                }
            });
        }
        <% } %>

        // Maintenance Frequency Chart
        <% if (maintenanceFrequency && maintenanceFrequency.length > 0) { %>
        const maintenanceFrequencyCtx = document.getElementById('maintenanceFrequencyChart');
        if (maintenanceFrequencyCtx) {
            new Chart(maintenanceFrequencyCtx, {
                type: 'bar',
                data: {
                    labels: [<%= maintenanceFrequency.map(v => `'#${v.numero_vehiculo}'`).join(',') %>],
                    datasets: [{
                        label: 'Mantenimientos por Mes',
                        data: [<%= maintenanceFrequency.map(v => v.maintenance_per_month || 0).join(',') %>],
                        backgroundColor: '#17a2b8',
                        borderColor: '#138496',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Mantenimientos por Mes'
                            }
                        }
                    }
                }
            });
        }
        <% } %>

        // Vehicle Comparisons Chart
        <% if (vehicleComparisons && vehicleComparisons.length > 0) { %>
        const vehicleComparisonsCtx = document.getElementById('vehicleComparisonsChart');
        if (vehicleComparisonsCtx) {
            new Chart(vehicleComparisonsCtx, {
                type: 'bar',
                data: {
                    labels: [<%= vehicleComparisons.map(v => `'#${v.numero_vehiculo}'`).join(',') %>],
                    datasets: [
                        {
                            label: 'Combustible',
                            data: [<%= vehicleComparisons.map(v => v.total_fuel_cost || 0).join(',') %>],
                            backgroundColor: '#4da6ff'
                        },
                        {
                            label: 'Mantenimiento',
                            data: [<%= vehicleComparisons.map(v => v.total_maintenance_cost || 0).join(',') %>],
                            backgroundColor: '#28a745'
                        },
                        {
                            label: 'Multas',
                            data: [<%= vehicleComparisons.map(v => v.total_fines_cost || 0).join(',') %>],
                            backgroundColor: '#ffc107'
                        },
                        {
                            label: 'Siniestros',
                            data: [<%= vehicleComparisons.map(v => v.total_claims_cost || 0).join(',') %>],
                            backgroundColor: '#dc3545'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('es-MX');
                                }
                            }
                        }
                    }
                }
            });
        }
        <% } %>

        // Carta Porte Monthly Chart
        <% if (cartaPorteMonthly && cartaPorteMonthly.length > 0) { %>
        const cartaPorteMonthlyCtx = document.getElementById('cartaPorteMonthlyChart');
        if (cartaPorteMonthlyCtx) {
            new Chart(cartaPorteMonthlyCtx, {
                type: 'line',
                data: {
                    labels: [<%= cartaPorteMonthly.map(c => `'${c.month}'`).join(',') %>],
                    datasets: [
                        {
                            label: 'Total Cartas Porte',
                            data: [<%= cartaPorteMonthly.map(c => c.total_cartas || 0).join(',') %>],
                            borderColor: '#4da6ff',
                            backgroundColor: 'rgba(77, 166, 255, 0.1)',
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Valor Total',
                            data: [<%= cartaPorteMonthly.map(c => c.total_valor || 0).join(',') %>],
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Cantidad'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Valor ($)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('es-MX');
                                }
                            }
                        }
                    }
                }
            });
        }
        <% } %>

        // Destination States Chart
        <% if (destinationStates && destinationStates.length > 0) { %>
        const destinationStatesCtx = document.getElementById('destinationStatesChart');
        if (destinationStatesCtx) {
            new Chart(destinationStatesCtx, {
                type: 'doughnut',
                data: {
                    labels: [<%= destinationStates.map(d => `'${d.destino_estado}'`).join(',') %>],
                    datasets: [{
                        data: [<%= destinationStates.map(d => d.count || 0).join(',') %>],
                        backgroundColor: [
                            '#4da6ff', '#28a745', '#ffc107', '#dc3545', '#17a2b8',
                            '#6f42c1', '#e83e8c', '#fd7e14', '#20c997', '#6c757d'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
        }
        <% } %>

        // Fixed vs Variable Costs Chart
        <% if (typeof fixedVariableBreakdown !== 'undefined' && fixedVariableBreakdown && fixedVariableBreakdown.length > 0) { %>
        const fixedVariableCtx = document.getElementById('fixedVariableChart');
        if (fixedVariableCtx) {
            try {
                new Chart(fixedVariableCtx, {
                    type: 'doughnut',
                    data: {
                        labels: [<%= fixedVariableBreakdown.map(c => `'${c.category}'`).join(',') %>],
                        datasets: [{
                            data: [<%= fixedVariableBreakdown.map(c => c.amount).join(',') %>],
                            backgroundColor: [<%= fixedVariableBreakdown.map(c => `'${c.color}'`).join(',') %>],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: $${value.toLocaleString('es-MX', {minimumFractionDigits: 2})} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                console.log('Fixed vs Variable Chart created successfully');
            } catch (error) {
                console.error('Error creating Fixed vs Variable Chart:', error);
            }
        }
        <% } %>

        // Fixed Costs Breakdown Chart
        <% if (typeof fixedCostsBreakdown !== 'undefined' && fixedCostsBreakdown && fixedCostsBreakdown.length > 0) { %>
        const fixedCostsCtx = document.getElementById('fixedCostsChart');
        if (fixedCostsCtx) {
            try {
                new Chart(fixedCostsCtx, {
                    type: 'bar',
                    data: {
                        labels: [<%= fixedCostsBreakdown.map(c => `'${c.category}'`).join(',') %>],
                        datasets: [{
                            label: 'Costo',
                            data: [<%= fixedCostsBreakdown.map(c => c.amount).join(',') %>],
                            backgroundColor: [<%= fixedCostsBreakdown.map(c => `'${c.color}'`).join(',') %>],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `$${context.parsed.y.toLocaleString('es-MX', {minimumFractionDigits: 2})}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString('es-MX');
                                    }
                                }
                            }
                        }
                    }
                });
                console.log('Fixed Costs Chart created successfully');
            } catch (error) {
                console.error('Error creating Fixed Costs Chart:', error);
            }
        }
        <% } %>

        // Variable Costs Breakdown Chart
        <% if (typeof variableCostsBreakdown !== 'undefined' && variableCostsBreakdown && variableCostsBreakdown.length > 0) { %>
        const variableCostsCtx = document.getElementById('variableCostsChart');
        if (variableCostsCtx) {
            try {
                new Chart(variableCostsCtx, {
                    type: 'bar',
                    data: {
                        labels: [<%= variableCostsBreakdown.map(c => `'${c.category}'`).join(',') %>],
                        datasets: [{
                            label: 'Costo',
                            data: [<%= variableCostsBreakdown.map(c => c.amount).join(',') %>],
                            backgroundColor: [<%= variableCostsBreakdown.map(c => `'${c.color}'`).join(',') %>],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `$${context.parsed.y.toLocaleString('es-MX', {minimumFractionDigits: 2})}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString('es-MX');
                                    }
                                }
                            }
                        }
                    }
                });
                console.log('Variable Costs Chart created successfully');
            } catch (error) {
                console.error('Error creating Variable Costs Chart:', error);
            }
        }
        <% } %>

        console.log('All charts initialized');
    </script>
</body>
</html>
